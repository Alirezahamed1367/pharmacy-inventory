# ุฑุงูููุง ฺฏุงูโุจูโฺฏุงู ุจูููโุณุงุฒ ู ฺฉูพุงุฑฺฺฏ ยซูุฑุงุฑุฏุงุฏ ุฏุงุฏูยป (Data Contract)

ุทุฑุงุญ ู ุชูุณุนู: ุนูุฑุถุง ุญุงูุฏ โ ูพุงุฒ ฑดฐด

ุงู ุณูุฏุ ููุดูโ ุฑุงู ุนูู ุจุฑุง ุงุทููุงู ุงุฒ ยซุซุจุงุชุ ุตุญุชุ ฺฉุงุฑุง ู ุชฺฉุงููโูพุฐุฑยป ูุฑุงุฑุฏุงุฏ ุฏุงุฏู (Data Contract) ุฏุฑ ุณุณุชู ูุฏุฑุช ููุฌูุฏ ุฏุงุฑูุฎุงูู ุงุณุช. ุชูุฑฺฉุฒ ุงุตู: ุณุงุฏฺฏุ ูุงุจูุช ููุฒุ ู ุฌููฺฏุฑ ุงุฒ ูุงฺฏุฑุง ุฏุงุฏู ุจู ฺฉูุงูุช ู ูพุงฺฏุงู ุฏุงุฏู.

---
## 1. ุชุนุงุฑู ูพุงู
| ุงุตุทูุงุญ | ูุนู | ูุซุงู ุฏุฑ ูพุฑูฺู |
|--------|------|---------------|
| Data Contract | ุชูุงูู ุตุฑุญ ุฏุฑุจุงุฑูู ุณุงุฎุชุงุฑุ ูุนุงูุ ููุน ู ูุญุฏูุฏุช ููุฏูุง | ุฌุฏูู `drugs` ุจุง ููุฏูุง (name, package_type, expire_date) ู ูุงุนุฏู UNIQUE |
| Invariant (ูุงูุฑุฏุง) | ูุงุนุฏูโุง ฺฉู ููุดู ุจุงุฏ ุจุฑูุฑุงุฑ ุจุงุดุฏ | ููุฌูุฏ ูฺโฺฏุงู ููู ููโุดูุฏ |
| Versioning | ูุฏุฑุช ุชฺฉุงูู ุจุฏูู ุดฺฉุณุชู ฺฉูุงูุช | ุชุบุฑ schema โ ุงูุฒุงุด metadata ูุณุฎู |

---
## 2. ูุฏู ุฏุงููู (Domain Model)
ููุฌูุฏุชโูุง:
- Users (ููุดโูุง: admin, manager)
- Warehouses
- Drugs (ูุฑ ุฑุฏู = ูุงุฑุงูุช ฺฉุชุง: name + package_type + expire_date)
- Inventory (ููุฌูุฏ ูุงูุน ูุฑ ูุงุฑุงูุช ุฏุฑ ูุฑ ุงูุจุงุฑ + batch ุงุฎุชุงุฑ)
- Receipts / Receipt Items (ูุฑูุฏ ุฑุณู ฺฉุงูุง)
- Transfers / Transfer Items (ุงูุชูุงู ุจู ุงูุจุงุฑูุง + ูุบุงุฑุช)
- Suppliers

ุฑูุงุจุท ฺฉูุฏ:
- inventory.drug_id โ drugs.id
- inventory.warehouse_id โ warehouses.id
- receipt_items.receipt_id โ receipts.id
- transfer_items.inventory_id โ inventory.id (ุฑุฏู ููุดุฃ ุงูุชูุงู)

---
## 3. ูุฑุงุฑุฏุงุฏ ุฏุงุฏู (Specification)
### 3.1 ูุงูโฺฏุฐุงุฑ
- snake_case ุฏุฑ ุฏุชุงุจุณ / camelCase ุฏุฑ ูุฑุงูุช ุฏุฑ ุตูุฑุช ูุงุฒ (ูุนูุงู JS ุฎุงู โ ููุงู snake_case ูฺฏู ุฏุงุดุชู ูโุดูุฏ)
- ููุฏูุง ุฒูุงู: created_at, updated_at, completed_at
### 3.2 ุงููุงุน (Types)
- UUID ุจุฑุง ุดูุงุณูโูุง (ูุฒุช: ุบุฑ ูุงุจู ุญุฏุณ + ููุงุฌุฑุช ุขุณุงู)
- DATE ููุท ุจุฑุง expire_date ุฏุฑ ุฌุฏูู drugs (ุงููุถุง ุฏุฑ inventory ุชฺฉุฑุงุฑ ููโุดูุฏ โ ุฌููฺฏุฑ ุงุฒ ูุงุณุงุฒฺฏุงุฑ)
- INTEGER ุจุฑุง quantity (ุจุง CHECK โฅ 0)
### 3.3 ูุงูุฑุฏุงโูุง (Invariants)
- (name, package_type, expire_date) ฺฉุชุง ุฏุฑ `drugs`
- (drug_id, warehouse_id, batch_number) ฺฉุชุง ุฏุฑ `inventory`
- quantity โฅ 0 ููุดู (ุฑุณุฏ / ุญูุงูู ุชููุง ูุณุฑ ุชุบุฑ)
- transfer.status โ {in_transit, completed, discrepancy}
- receipt.status โ {pending, completed}
### 3.4 ููุงูู ุนููุงุช
| ุนููุงุช | ููุจุน ุญููุช | ูุณุฑ ูุฌุงุฒ | ุฑุฏ ุญุงูุช ุบุฑูุฌุงุฒ |
|--------|------------|-----------|------------------|
| ุงูุฒูุฏู ููุฌูุฏ | receipts.complete | receipt_items โ inventory upsert | ูุฑุงุด ูุณุชูู ุฌุฏูู inventory |
| ุงูุชูุงู ุงูุจุงุฑ | transfers.create / complete | ฺฉุงูุด ูุจุฏุงุ ุงูุฒูุฏู ููุตุฏ | ุฏุฑุฌ ูุณุชูู ุฏุฑ inventory ููุตุฏ |
| ุงุตูุงุญ ูุบุงุฑุช | completeTransfer ุจุง quantity_received | ุซุจุช status discrepancy | ุฏุณุชฺฉุงุฑ ุฏุณุช ุฑฺฉูุฑุฏ transfer_items |

---
## 4. ูุณุฎูโุจูุฏ (Evolution & Versioning)
ูพุดููุงุฏ: ุงูุฒูุฏู ุฌุฏูู `system_metadata (key TEXT PRIMARY KEY, value TEXT)` ู ูฺฏูุฏุงุฑ `schema_version`.
ููููู ุจูโุฑูุฒุฑุณุงู:
```sql
INSERT INTO system_metadata(key,value) VALUES('schema_version','2.0')
ON CONFLICT (key) DO UPDATE SET value = EXCLUDED.value;
```
ุงุตูู:
1. ุงุถุงูู ฺฉุฑุฏู ููุฏ ุฌุฏุฏ โ NULLable + ุงูุชุดุงุฑ ฺฉูุงูุช ุฌุฏุฏ โ ุจุนุฏ ุงุฌุจุงุฑโุณุงุฒ.
2. ุชุบุฑ ููุน ููุฏ โ ูุฑุญููโ Migration ุจุง ุณุชูู ุฌุฏุฏ + ุงูุชูุงู ุฏุงุฏู + ุญุฐู ูุฏู.
3. ุญุฐู ููุฏ โ Deprecation ุงุนูุงู + ุญุฏุงูู ฑ ฺุฑุฎู ุงูุชุดุงุฑ.

---
## 5. ุงุนุชุจุงุฑุณูุฌ (Validation Strategy)
ูุงูโูุง:
1. UI: ุฌููฺฏุฑ ุงุฒ ุงุฑุณุงู ูุงูุต (ูุซุงู: ูุงู ุฏุงุฑู + ุชุงุฑุฎ ุงููุถุง ุงูุฒุงู)
2. Service Layer (supabase.js): ุจุงุฒฺฏุฑุฏุงูุฏู ูพุงู ุฎุทุง ูุนูุงุฏุงุฑ:
```javascript
if (!name || !expire_date) return { error: { message: 'ูุงู ู ุชุงุฑุฎ ุงููุถุง ุงูุฒุงู ูุณุชูุฏ' } }
```
3. ูพุงฺฏุงู ุฏุงุฏู: CHECK ู UNIQUE (ุขุฎุฑู ุฎุท ุฏูุงุน)

ฺฺฉ ูุณุช ุงุนุชุจุงุฑุณูุฌ:
- ูุฑูุฏ ุฏุงุฑู ุชฺฉุฑุงุฑุ โ ุฎุทุง ููุญุตุฑ ุจูุฑุฏ ุจูุฏู
- ุชุนุฏุงุฏ ูููุ โ ุฑุฏ ุฏุฑ ุงูุชูุงู / ุฑุณุฏ
- ุงูุชูุงู ุจู ููุงู ุงูุจุงุฑุ โ CHECK ููุทู ุฏุฑ createTransfer

---
## 6. ูุฏุฑุช ุฎุทุง (Error Handling)
ูุฑูุช ูพุดููุงุฏ ูพุงุณุฎ ุฏุฑ Service:
```json
{ "data": <any|null>, "error": { "message": "..." } }
```
ููุงุด ุฏุฑ UI: Alert ูุงุฑุณ + ุงูฺฉุงู Retry.

---
## 7. ุจูููโุณุงุฒ ูพุงฺฏุงู ุฏุงุฏู (DB Optimization)
### 7.1 ุงูุฏฺฉุณโูุง ูพุดููุงุฏ
```sql
-- ุฌุณุชุฌู ุณุฑุน ุจุฑ ุงุณุงุณ ุชุงุฑุฎ ุงููุถุง
CREATE INDEX IF NOT EXISTS idx_drugs_expire_date ON drugs(expire_date);

-- ฺฏุฒุงุฑุดโุฏู ุณุฑุน ุจุฑ ุงุณุงุณ ุงูุจุงุฑ
CREATE INDEX IF NOT EXISTS idx_inventory_warehouse ON inventory(warehouse_id);

-- ุชุฑฺฉุจ ุจุฑุง ฺฉูุฆุฑ ูพุฑุชฺฉุฑุงุฑ (ุฏุงุฑู + ุงูุจุงุฑ)
CREATE INDEX IF NOT EXISTS idx_inventory_drug_warehouse ON inventory(drug_id, warehouse_id);

-- ูุถุนุชโูุง ุจุฑุง ููุชุฑ ูุณุชโูุง
CREATE INDEX IF NOT EXISTS idx_receipts_status ON receipts(status);
CREATE INDEX IF NOT EXISTS idx_transfers_status ON transfers(status);
```
### 7.2 ฺฉุงูุด Round Trip
- ฺฏุฑููโุจูุฏ SELECT ูุง: ุงุณุชูุงุฏู ุงุฒ `getInventoryDetailed()` ุจุฌุง ฺูุฏู ูุฑุงุฎูุงู ูุฌุฒุง.
- ููุท ููุฏูุง ูุงุฒู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏุ ุฏุฑ ุตูุฑุช ุฑุดุฏ ูพุฑูฺูุ Projection ูุฏูููุฏ.

---
## 8. ุงูฺฏู ูุฑุงุฎูุงู API / Service Layer
ุงูฺฏู ูุนู: ุชูุงุจุน ูุงฺูู `supabase.js`.
ุจูุจูุฏ ูพุดููุงุฏ: ุงุถุงูู ฺฉุฑุฏู Wrapper ุฎุทุง + Logging ุณุทุญ debug.
ูุซุงู Wrapper:
```javascript
async function wrap(name, fn) {
  try { return await fn() } catch (e) { return { data: null, error: { message: `${name} failed: ${e.message}` } } }
}
```

---
## 9. ูุฏุฑุช ููุงุฌุฑุช (Migrations)
ฺุฑุฎู ูพุดููุงุฏ:
1. ููุดุชู ูุงู SQL ุฌุฏุงฺฏุงูู (`/database/migrations/2025_10_02_add_indexes.sql`)
2. ุงุฌุฑุง ูุญู ู ุฑู ูุญุท ุชุณุช
3. ุจูโุฑูุฒุฑุณุงู ูุณุฎู ุฏุฑ system_metadata
4. ุซุจุช ุฏุฑ CHANGELOG ูุฎุชุตุฑ

---
## 10. ุชุณุช (Testing Strategy)
### ุงููุงุน ุชุณุช:
- Unit: ุชูุงุจุน ูุญุงุณุจู diffDays / ุฏุณุชูโุจูุฏ ุงููุถุง
- Integration: ุณูุงุฑู Receipt โ Inventory
- Workflow: createTransfer โ completeTransfer (Case: discrepancy)

### ุณูุงุฑููุง ฺฉูุฏ
| ุณูุงุฑู | ฺฏุงูโูุง | ุงูุชุธุงุฑ |
|--------|--------|--------|
| ูุฑูุฏ ุฑุณุฏ | createReceipt + completeReceipt | ุงูุฒุงุด ููุฌูุฏ ุง ุงุฌุงุฏ ุฑฺฉูุฑุฏ ุฌุฏุฏ |
| ุงูุชูุงู ุนุงุฏ | createTransfer (ฺฉุงูุด ูุจุฏุง) + completeTransfer (ุงูุฒุงุด ููุตุฏ) | status=completed |
| ุงูุชูุงู ุจุง ูุบุงุฑุช | quantity_received โ quantity_sent | status=discrepancy |
| ุงููุถุง | ุฏุงุฑู ุจุง expire_date ฺฏุฐุดุชู | ุฏุฑ ูุณุช expired |

---
## 11. ูุงูุชูุฑูฺฏ ู ูุงฺฏ
ูุนูุงู: Console logging.
ูพุดููุงุฏ ุขูุฏู: ูุงฺฏ ุณุงุฎุชโุงูุชู (JSON) + ุฌุฏูู ุจุฑุง ุฑุฎุฏุงุฏูุง ุญุณุงุณ (audit_log).

---
## 12. ุงููุช ู RBAC
- ูุนูุงู RLS ุบุฑูุนุงู (ูุฑุญูู ุชูุณุนู). ูุฑุญูู ุจุนุฏ: ูุนุงูโุณุงุฒ RLS + Policies:
```sql
ALTER TABLE inventory ENABLE ROW LEVEL SECURITY;
CREATE POLICY sel_inventory_admin ON inventory FOR SELECT USING (true);
```
- ุฐุฎุฑู ูฺฉุฑุฏู ุฑูุฒ ุนุจูุฑ ุฎุงู (ุฏุฑ schema ูุนู password_hash ููุฌูุฏ ุงุณุช โ ุงุทููุงู ุงุฒ bcrypt ุณูุช ุจฺฉโุงูุฏ).

---
## 13. ุจูููโุณุงุฒ ุดุจฺฉู / ูุงฺฉูุดโูพุฐุฑ
- ูุดุฑุฏูโุณุงุฒ ุชุตุงูุฑ (Implemented WebP <= ~300KB)
- ุชูุณู ุจุงุฑ ุฏุฑุฎูุงุณุชโูุง (Lazy load Reports)
- Debounce ุฌุณุชุฌู ุฏุงุฑู (ุฏุฑ ุตูุฑุช ุงูุฒุงุด ุญุฌู)

---
## 14. ูุฏุฑุช ุชุตุงูุฑ
Pipeline ูุนู:
1. Resize ุจุง Canvas
2. WebP ุจุง ฺฉูุช ุชุทุจู
3. ููุงุด ูุชุฑฺฉ (originalKB / finalKB / ratio)
ูพุดููุงุฏ ุจุนุฏ: ฺฉุด CDN ุง Storage Transform.

---
## 15. ูพุดุชุจุงูโฺฏุฑ ู Disaster Recovery
โ ุงุณฺฉุฑูพุช ุชูุณุนู ุฏุงุฏู ุดุฏู (`backup_system.py`):
- ูุณุฎู + hash + ูุชุงุฏุชุง
- ูุดุฑุฏูโุณุงุฒ (zip / tar.gz)
- ูุงุจูุช ุงูุฒูุฏู ููุตุฏ (GitHub / Email)

ฺฺฉ ูุณุช ุฑูุฒุงูู:
| ููุฑุฏ | ูุถุนุช |
|------|--------|
| ุชููุฏ ูุงู | โ |
| ุจุฑุฑุณ ูุด | โ |
| ุชุณุช ุจุงุฒุงุจ | (ุญุฏุงูู ููุชฺฏ) |

---
## 16. ฺฺฉ ูุณุช ุงูุชุดุงุฑ (Release Checklist)
- [ ] Migrations ุงุฌุฑุง ุดุฏู
- [ ] ูุณุฎู schema ุจูโุฑูุฒ
- [ ] ุชุณุช ุณูุงุฑููุง Receipt/Transfer ูพุงุณ
- [ ] ฺฏุฒุงุฑุด ุงููุถุง ุตุญุชโุณูุฌ ุดุฏ
- [ ] ุจฺฉุงูพ ุขุฎุฑ < 24h
- [ ] ุฎุทุงูุง ูุฑูุฑฺฏุฑ ุจุฏูู Exception ุญู ูุดุฏู
- [ ] ุงูุฏุงุฒู ุจุงูุฏู (ุฏุฑ ุตูุฑุช ุงูุฒูุฏู ฺฉุชุงุจุฎุงูู) ุจุฑุฑุณ

---
## 17. ููุดู ุจูุจูุฏูุง ุขูุฏู
| ุงูููุช | ููุฑุฏ | ุชูุถุญ |
|--------|------|-------|
| ุจุงูุง | RLS + Policies | ุงุฒูููโุณุงุฒ ุฏุณุชุฑุณ ุฏุฑ Supabase |
| ุจุงูุง | ุชุณุช ุฎูุฏฺฉุงุฑ | ุงูุฒูุฏู vitest / jest ุจุฑุง ูุญุงุณุจุงุช ู Service mock |
| ูุชูุณุท | TypeScript Migration | ฺฉุงูุด ุจุงฺฏ ูุฑุงุฑุฏุงุฏ ุฏุงุฏู |
| ูุชูุณุท | Audit Log | ุฑูฺฏุฑ ูุนุงูุช ุญุณุงุณ (ุญุฐู ุฏุงุฑูุ ูุบุงุฑุช) |
| ูพุงู | ฺฏุฒุงุฑุดโฺฏุฑ ูพุดุฑูุชู | Pivot ุงูุจุงุฑ / ุงููุถุง / ููุฌูุฏ ุจุฑุง BI |

---
## 18. ููููู ฺฉุฏ ุจูุจูุฏ ุงูุชู (Grouping + Expiry Classification)
```javascript
// ุฏุณุชูโุจูุฏ ฺฉุจุงุฑู ูพุณ ุงุฒ fetch
function classifyExpiry(items) {
  const today = new Date();
  return items.map(it => {
    if (!it.expire_date) return { ...it, expiry_status: 'unknown' };
    const d = new Date(it.expire_date);
    const diff = Math.ceil((d - today) / 86400000);
    let status = 'healthy';
    if (diff < 0) status = 'expired';
    else if (diff <= 30) status = 'soon';
    else if (diff <= 90) status = 'mid';
    return { ...it, diffDays: diff, expiry_status: status };
  });
}
```

---
## 19. ฺฺฉ ูุณุช ุฑูุฒูุฑู ุชูุณุนูโุฏููุฏู (Dev Daily Checklist)
- [ ] ุงุฌุฑุง lint (ุฏุฑ ุตูุฑุช ุงุถุงููโุดุฏู)
- [ ] ุจุฑุฑุณ ูุงฺฏ ุฎุทุง ุฏุฑ ฺฉูุณูู ูุฑูุฑฺฏุฑ
- [ ] ูุฑูุฑ ุงูุฏุงุฒู Requests ุดุจฺฉู (Network โ Largest Payload)
- [ ] ุตุญุช ุชุงุฑุฎโูุง ุงููุถุง (UTC vs Local) โ ุงุณุชูุงุฏู ุงุฒ DATE ุจุฏูู TZ โ

---
## 20. ุฎูุงุตู
ุจุง ุฌุฏุงุณุงุฒ ยซุงุทูุงุนุงุช ุซุงุจุช (drugs)ยป ุงุฒ ยซุชุญุฑฺฉุงุช ููุฌูุฏ (receipts/transfers)ยป ู ุชุญูู ูุณุฑูุง ุฑุณู ุจุฑุง ุชุบุฑ ููุฌูุฏุ Data Contract ุดูุง ูุงุจู ุงุนุชูุงุฏ ู ูพุงุฏุงุฑ ุจุงู ูโูุงูุฏ. ุงู ุณูุฏ ุฑุง ุจูโุฑูุฒุฑุณุงู ฺฉูุฏ ูุฑ ุฒูุงู ฺฉู:
- ููุฏ ุฌุฏุฏ ุงูุฒูุฏู ูโุดูุฏ
- ุฑูุชุงุฑ ูุฑุขูุฏ ูุฑูุฏ/ุงูุชูุงู ุชุบุฑ ูโฺฉูุฏ
- ุณุงุณุช ุงููุช ุฌุฏุฏ ุงุนูุงู ูโฺฏุฑุฏุฏ

ูููู ุจุงุดุฏ ๐ฑ
